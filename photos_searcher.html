<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searcher</title>
    <link rel="stylesheet" type="text/css" href="./static/content/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./static/content/site.css" />
    <script src="./static/scripts/modernizr-2.6.2.js"></script>
    <script src="./static/scripts/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="./static/scripts/bootstrap.min.js"></script>
    <script src="./static/scripts/respond.js"></script>
</head>
<body>
<canvas></canvas>
<div class="container body-content" id="body1" style="display:none">
<div class="jumbotron">
    <div class="row" id="row">
        <div class="col-md-1 p-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    <div id="dn">区县</div>
                    <span class="caret"></span>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="javascript:setDistrict(110108,'海淀区')">海淀区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110107,'石景山区')">石景山区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110109,'门头沟区')">门头沟区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110120,'燕山区')">燕山区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110106,'丰台区')">丰台区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110105,'朝阳区')">朝阳区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110102,'西城区')">西城区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110101,'东城区')">东城区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110114,'昌平区')">昌平区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110115,'大兴区')">大兴区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110116,'怀柔区')">怀柔区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110117,'平谷区')">平谷区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110111,'房山区')">房山区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110112,'通州区')">通州区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110113,'顺义区')">顺义区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110229,'延庆区')">延庆区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110228,'密云区')">密云区</a>
                    <a class="dropdown-item" href="javascript:setDistrict(110000,'北京市')">北京市</a>
                </div>
            </div>
        </div>
        <div class="col-md-3 p-3">
            <div class="input-group input-group-lg border border-primary rounded-lg">
                <div class="input-group-prepend">
                    <span class="input-group-text">毕业年份:</span>
                </div>
                <input type="text" class="form-control" style="height:auto;" placeholder="2022" disabled="disabled" id="grade" value="2022"/>
                <div class="btn-group-sm btn-group-vertical">
                    <button type="button" class="btn btn-primary" onclick="$('#grade').attr('value',parseInt($('#grade').val()) + 1)">&uArr;</button>
                    <button type="button" class="btn btn-primary" onclick="$('#grade').attr('value',parseInt($('#grade').val()) - 1)">&dArr;</button>
                </div>

            </div>


        </div>
        <div class="col-md-4 p-3">
            <div class="input-group input-group-lg h-100">
                <div class="input-group-prepend">
                    <span class="input-group-text">教育ID:</span>
                </div>
                <input type="text" class="form-control h-100" placeholder="10174389" id="id" />
                <div class="input-group-append">
                    <button class="btn btn-primary" onclick="search()">搜索</button>
                </div>
            </div>
        </div>
        <div class="col-md-4" onclick="_switch()">
            <h4 class="p-3 m-3">无服务器模式</h4>
            <!--<img src="http://211.153.80.221/static/cmisfolder/photos/2012003/2021/01124006/09068847.JPG">-->
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card card-default">
            <div class="card-header">未搜到</div>
            <div class="card-body">
                <img id="pSp" style="width:120px;height:160px" src="https://qlogo3.store.qq.com/qzone/1736319094/1736319094/100?1594915443" />
            </div>
            <div class="card-footer">
                <div class="progress progress-striped active">
                    <div class="progress-bar progress-bar-success" role="progressbar"
                         aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"
                         id="pPrg">
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-4">
        <div class="card card-default">
            <div class="card-header">未搜到</div>
            <div class="card-body">
                <img id="mSp" style="width:120px;height:160px" src="https://qlogo3.store.qq.com/qzone/1736319094/1736319094/100?1594915443" />
            </div>
            <div class="card-footer">
                <div class="progress progress-striped active">
                    <div class="progress-bar progress-bar-success" role="progressbar"
                         aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"
                         id="mPrg">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-default">
            <div class="card-header">未搜到</div>
            <div class="card-body">
                <img id="hSp" style="width:120px;height:160px" src="https://qlogo3.store.qq.com/qzone/1736319094/1736319094/100?1594915443" />
            </div>
            <div class="card-footer">
                <div class="progress progress-striped active">
                    <div class="progress-bar progress-bar-success" role="progressbar"
                         aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"
                         id="hPrg">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div><!--图片显示框-->
</div>
<div class="container body-content" id="body2">
<div class="jumbotron" >
    <div class="row">
        <div class="col-md-7 p-4">
            <div class="input-group input-group-sm" onload="body2load()">
              <div class="input-group-prepend">
                <button type="button" class="btn btn-primary dropdown-toggle" id="linkTitle" data-toggle="dropdown">
                  选择网站
                </button>
                <div class="dropdown-menu" id="linkList">
                  <!--<a class="dropdown-item" href="https://www.google.com">GOOGLE</a>
                  <a class="dropdown-item" href="https://www.runoob.com">RUNOOB</a>
                  <a class="dropdown-item" href="https://www.taobao.com">TAOBAO</a>-->
                </div>
              </div>
                <input type="text" class="form-control" placeholder="photoUrl" id="url">
                <div class="input-group-append">
                    <button class="btn btn-success" type="button" onclick='go($("#url").val())'>Go</button>
                </div>
            </div>
        </div>
        <div class="col-md-4" onclick="_switch()">
            <h4 class="p-3 m-3">自助查询</h4>
        </div>
        <div class="card m-4">
            <div class="card-body" id="photo">

            </div>
        </div>
    </div>
</div>
<script>
    String.prototype.format = function (args) {
    var result = this;
    if (arguments.length > 0) {
        if (arguments.length == 1 && typeof (args) == "object") {
            for (var key in args) {
                if (args[key] != undefined) {
                    var reg = new RegExp("({" + key + "})", "g");
                    result = result.replace(reg, args[key]);
                }
            }
        }
        else {
            for (var i = 0; i < arguments.length; i++) {
                if (arguments[i] != undefined) {
                    var reg = new RegExp("({[" + i + "]})", "g");
                    result = result.replace(reg, arguments[i]);
                }
            }
        }
    }
    return result;
}
    function sub_pic(url, onok) {
        var tmp = document.createElement("img");
        tmp.src = url;
        tmp.onload = (ev) => {
            onok(true, ev,url);
        }
        tmp.onerror = () => {
            onok(false, null,url);
        }
    }

    function s_sub_pic(baseurl,grade, ss, uid,i,ii,onok) {
        sub_pic(baseurl.format({
            "level": "201200" + (parseInt(ii) + 1), "grade": parseInt(grade) - 3 * (2 - ii), "sid": ss[i]["id"], "uidi": uid
        }), (status, ev, url) => {
                onok(status, url, ii, i);
        }
        );
    }
    function progressBar(view) {
        return parswInt($(view).css("width").replace("%", "")) / 100;
    }

    function progressBar(view, degree) {
        $(view).css("width", degree*100+"%");
    } 
    
    var ss = {}

    function setDistrict(a, d) {
        $("#dn").text(d);
        $.ajax({
            type: "get",
            url: "./static/data/" + a+".json",
            dataType: "json",
            success: function (data) {
                ss = data;
            }
        });
    }
    //var baseUrl1 = "http://211.153.82.232/cmisfolder/photos/{level}/{grade}/{sid}/{uid}.JPG";
    //var baseUrl2 = "http://211.153.82.232/cmisfolder/photos/{level}/{grade}/{sid}/{uid}.jpg";
    var ll=[];
    var mainLink;
    $.ajax({
        type: "get",
        url: "./static/data/photoLink.json",
        dataType: "json",
        success: function (data) {
            ll = data;
            mainLink=ll[0]
            $("#linkTitle").text(ll[0])
            for(i in data){
                $("#linkList").append('<a class="dropdown-item" href="javascript: setLink('+i+')">'+data[i]+'</a>')
            }
        }
    });
    
    function main_re() {
        var pid = ["#pSp", "#mSp", "#hSp"];
        var nid = ["#pSn", "#mSn", "#hSn"];
        var Prgid = ["#pPrg","#mPrg","#hPrg"]
        var baseUrl1 = mainLink+"/cmisfolder/photos/{level}/{grade}/{sid}/{uidi}.JPG"
        var baseUrl2 = mainLink+"/cmisfolder/photos/{level}/{grade}/{sid}/{uidi}.jpg"
        for (var ii in [0, 1, 2]) {
            $(nid[ii]).text("未搜到");
            $(pid[ii]).attr("src", "https://qlogo3.store.qq.com/qzone/1736319094/1736319094/100?1594915443");
            progressBar(Prgid[ii], 0);
        }
        for (var i in ss) {
            for (var ii in [1, 2, 3]) {
                console.log(ss[i]["id"] + " " + ii)
                function sub(status, url, ii, i){
                    console.log(url)
                    if (status) {
                        $(nid[ii]).text(ss[i]["text"]);
                        $(pid[ii]).attr("src", url);
                        progressBar(Prgid[ii], 1);
                    }
                    if (progressBar(Prgid[ii]) != 1) {
                        progressBar(Prgid[ii], i / ss.length)
                    }
                }
                s_sub_pic(baseUrl1, $("#grade").val(), ss, $("#id").val(), i, ii, sub);
                s_sub_pic(baseUrl2, $("#grade").val(), ss, $("#id").val(), i, ii, sub);
            }
        }
    }
    function search() {
        if (!ss.length) {
            alert("请选择区县")
        } else if ($("#id").val() == "") {
            alert("请输入id")
        }else {
            main_re();
        }
    }
    var a=true;
    function _switch(){
        a=!a;
        if(!a){
            $("#body1").hide()
            $("#body2").show()
        }else{
            $("#body2").hide()
            $("#body1").show()
        }
    }
    function setLink(n){
        mainLink=ll[n]
        $("#linkTitle").text(mainLink)
    }

    function go(url){
        console.log(url)
        sub_pic(mainLink+url,(status,ev,url)=>
        {
            console.log(ev)
            $("#photo").html("")
            if(status){
                $("#photo").append(ev.target)
                $("img").attr("style","width:240px;height:320px")
            }else{
                $("#photo").append("<h2>照片未找到</h2>")
            }
        })
    }



</script>
</div>
</body>
</html>
